<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Spring Boot WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .input-group { margin: 10px 0; }
        input[type="text"], input[type="number"] {
            padding: 8px; margin: 5px; width: 200px;
        }
        button {
            padding: 10px 15px; margin: 5px;
            background-color: #007bff; color: white;
            border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #messages {
            border: 1px solid #ccc; height: 400px;
            overflow-y: auto; padding: 10px; margin: 20px 0;
            background-color: #f9f9f9;
        }
        .message { margin: 5px 0; padding: 5px; }
        .my-message { text-align: right; color: #007bff; }
        .other-message { text-align: left; color: #333; }
        .error-message { color: red; font-weight: bold; }
        .system-message { color: green; font-style: italic; }
        .status { margin: 10px 0; padding: 10px; background-color: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Spring Boot WebSocket Chat Test</h1>

    <div class="status">
        <strong>연결 상태:</strong> <span id="connectionStatus">연결 중...</span>
    </div>

    <div class="input-group">
        <h3>사용자 정보</h3>
        <div style="margin-bottom: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
            <strong>💡 테스트 가이드:</strong><br>
            • <strong>탭 1 (게시글 작성자)</strong>: 이름=사용자1, 이메일=user1@user.com<br>
            • <strong>탭 2 (채팅 신청자)</strong>: 이름=사용자2, 이메일=user2@user.com<br>
            각 탭에서 해당 사용자 정보로 수정한 후 테스트하세요!<br><br>
            <strong>📝 사용자2 정보:</strong><br>
            JWT Token: <code style="font-size: 12px;">eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMkB1c2VyLmNvbSIsImlkIjo0LCJyb2xlIjoiVVNFUiIsImlhdCI6MTc1Mzc2OTk5NiwiZXhwIjoxNzUzNzcxNzk2fQ.UEmZ7n-r1VstflEaGpdi2fDxKjywJzrN83fkCwh9fkI</code>
        </div>
        <input type="text" id="senderName" placeholder="Your name" value="사용자1">
        <input type="text" id="senderEmail" placeholder="Your email" value="user1@user.com">
        <input type="text" id="jwtToken" placeholder="JWT Token" value="eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMUB1c2VyLmNvbSIsImlkIjozLCJyb2xlIjoiVVNFUiIsImlhdCI6MTc1Mzc2OTk5NiwiZXhwIjoxNzUzNzcxNzk2fQ.example_token_for_user1" style="width: 400px;">
    </div>

    <div class="input-group">
        <h3>채팅방 관리</h3>
        <input type="number" id="postId" placeholder="Post ID" value="1">
        <button onclick="createAndJoinChatRoom()" id="createBtn">Create & Join Chat Room</button>
        <button onclick="loadMyChatRooms()">내 채팅방 목록</button>
    </div>

    <div class="input-group">
        <h3>메시지 전송</h3>
        <input type="text" id="messageInput" placeholder="Message" onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()" id="sendBtn" disabled>Send Message</button>
        <button onclick="loadChatHistory()" id="historyBtn" disabled>Load Chat History</button>
    </div>

    <div class="status">
        <strong>현재 채팅방:</strong> <span id="currentChatRoom">없음</span>
    </div>

    <div id="messages"></div>
</div>

<script>
    var stompClient = null;
    var currentChatRoomId = null;
    var currentUserEmail = null;
    var isConnected = false;

    function updateConnectionStatus(status) {
        document.getElementById('connectionStatus').textContent = status;
        isConnected = (status === '연결됨');

        if (isConnected) {
            document.getElementById('connectionStatus').style.color = 'green';
        } else {
            document.getElementById('connectionStatus').style.color = 'red';
        }
    }

    function connect() {
        currentUserEmail = document.getElementById('senderEmail').value;
        console.log('=== WebSocket 연결 시작 ===');
        console.log('사용자 이메일:', currentUserEmail);

        // SockJS 연결 (헤더 제거)
        var socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);

        // 디버그 모드 활성화
        stompClient.debug = function(str) {
            console.log('STOMP Debug:', str);
        };

        // STOMP connect 시 사용자 정보를 헤더에 포함
        var connectHeaders = {
            'user-email': currentUserEmail
        };
        console.log('STOMP 연결 헤더:', connectHeaders);

        stompClient.connect(connectHeaders, function (frame) {
            console.log('=== WebSocket 연결 성공 ===');
            console.log('Connected frame:', frame);
            console.log('User principal:', frame.headers['user-name']);
            updateConnectionStatus('연결됨');

            // 전역 에러 메시지 구독
            stompClient.subscribe('/user/queue/error', function (errorMessage) {
                console.log('Error message received:', errorMessage);
                showErrorMessage(JSON.parse(errorMessage.body));
            });

            addSystemMessage('WebSocket 연결 성공');
            addSystemMessage('사용자: ' + frame.headers['user-name']);

        }, function(error) {
            console.log('=== WebSocket 연결 실패 ===');
            console.log('Connection error:', error);
            updateConnectionStatus('연결 실패');
            addSystemMessage('WebSocket 연결 실패: ' + error);
        });
    }

    var currentSubscription = null; // 현재 구독 정보 저장

    async function createAndJoinChatRoom() {
        var postId = document.getElementById('postId').value;
        var senderName = document.getElementById('senderName').value;
        var senderEmail = document.getElementById('senderEmail').value;
        var jwtToken = document.getElementById('jwtToken').value;

        if (!postId || !senderName || !senderEmail || !jwtToken) {
            alert('모든 필드를 입력해주세요!');
            return;
        }

        if (!isConnected) {
            alert('WebSocket이 연결되지 않았습니다. 페이지를 새로고침 해주세요.');
            return;
        }

        document.getElementById('createBtn').disabled = true;

        try {
            console.log('=== 채팅방 생성/참여 시작 ===');
            console.log('게시글 ID:', postId);
            console.log('사용자 이메일:', senderEmail);

            // 채팅방 생성/참여 API 호출
            const response = await fetch(`/api/chat/rooms/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            if (response.ok) {
                const result = await response.json();
                console.log('서버 응답:', result);

                const receivedChatRoomId = result.data;

                // 이미 같은 채팅방에 참여 중인 경우 중복 구독 방지
                if (currentChatRoomId === receivedChatRoomId && currentSubscription) {
                    console.log('⚠️ 이미 같은 채팅방에 참여 중입니다.');
                    addSystemMessage('이미 채팅방 ' + receivedChatRoomId + '에 참여 중입니다.');
                    return;
                }

                // 기존 구독이 있으면 해제
                if (currentSubscription) {
                    console.log('기존 구독 해제:', currentChatRoomId);
                    currentSubscription.unsubscribe();
                    currentSubscription = null;
                }

                // 새 채팅방 정보 설정
                currentChatRoomId = receivedChatRoomId;
                updateCurrentChatRoom(currentChatRoomId);

                // WebSocket 구독 설정
                const subscriptionPath = '/topic/chat/' + currentChatRoomId;
                console.log('=== WebSocket 구독 설정 ===');
                console.log('구독 경로:', subscriptionPath);
                console.log('채팅방 ID:', currentChatRoomId);

                currentSubscription = stompClient.subscribe(subscriptionPath, function (chatMessage) {
                    console.log('=== WebSocket 메시지 수신 ===');
                    console.log('Raw message:', chatMessage);
                    console.log('Message body:', chatMessage.body);

                    try {
                        const parsedMessage = JSON.parse(chatMessage.body);
                        console.log('Parsed message:', parsedMessage);
                        showMessage(parsedMessage);
                    } catch (e) {
                        console.error('메시지 파싱 에러:', e);
                    }
                });

                console.log('✅ WebSocket 구독 완료');

                // 성공 메시지 표시
                if (currentChatRoomId) {
                    addSystemMessage('✅ 채팅방 참여 성공! (ID: ' + currentChatRoomId + ')');
                    addSystemMessage('📡 WebSocket 구독 완료: ' + subscriptionPath);
                    addSystemMessage('💬 이제 실시간 채팅이 가능합니다!');
                }

                // UI 활성화
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('historyBtn').disabled = false;

                // 채팅 기록 자동 로드
                setTimeout(() => {
                    addSystemMessage('📋 채팅 기록을 불러옵니다...');
                    loadChatHistory();
                }, 500);

            } else {
                const errorText = await response.text();
                console.error('채팅방 생성/참여 실패:', errorText);
                addErrorMessage('채팅방 생성/참여 실패: ' + errorText);
            }

        } catch (error) {
            console.error('채팅방 생성/참여 중 오류:', error);
            addErrorMessage('채팅방 생성/참여 중 오류 발생: ' + error.message);
        } finally {
            document.getElementById('createBtn').disabled = false;
        }
    }

    async function loadMyChatRooms() {
        var jwtToken = document.getElementById('jwtToken').value;

        if (!jwtToken) {
            alert('JWT 토큰을 입력해주세요!');
            return;
        }

        try {
            const response = await fetch('/api/chat/rooms/my', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            if (response.ok) {
                const result = await response.json();
                console.log('My chat rooms:', result);

                addSystemMessage('=== 내 채팅방 목록 ===');
                if (result.data && result.data.length > 0) {
                    result.data.forEach(room => {
                        addSystemMessage(`방 ID: ${room.id}, 이름: ${room.name}, 마지막 메시지: ${room.lastContent}`);
                    });
                } else {
                    addSystemMessage('참여 중인 채팅방이 없습니다.');
                }
                addSystemMessage('==================');

            } else {
                const errorText = await response.text();
                addErrorMessage('채팅방 목록 조회 실패: ' + errorText);
            }
        } catch (error) {
            addErrorMessage('채팅방 목록 조회 중 오류: ' + error.message);
        }
    }

    async function loadChatHistory() {
        console.log('=== loadChatHistory 시작 ===');
        console.log('currentChatRoomId:', currentChatRoomId);

        if (!currentChatRoomId) {
            alert('먼저 채팅방에 참여해주세요!');
            return;
        }

        var jwtToken = document.getElementById('jwtToken').value;
        console.log('JWT Token exists:', !!jwtToken);

        document.getElementById('historyBtn').disabled = true;

        try {
            // 기본 API 호출 (페이징 제거)
            const url = `/api/chat/rooms/${currentChatRoomId}/messages`;
            console.log('API 호출 URL:', url);

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);

            if (response.ok) {
                const result = await response.json();
                console.log('Chat history 응답:', result);

                if (result.data && result.data.length > 0) {
                    addSystemMessage(`=== 채팅 기록 (총 ${result.data.length}개) ===`);

                    result.data.forEach((message, index) => {
                        console.log(`메시지 ${index}:`, message);
                        showHistoryMessage(message);
                    });

                    addSystemMessage('================');
                } else {
                    console.log('메시지가 없음');
                    addSystemMessage('메시지가 없습니다.');
                }

            } else {
                const errorText = await response.text();
                console.error('API 에러 응답:', errorText);
                addErrorMessage('채팅 기록 조회 실패: ' + errorText);
            }
        } catch (error) {
            console.error('loadChatHistory catch 에러:', error);
            addErrorMessage('채팅 기록 조회 중 오류: ' + error.message);
        } finally {
            document.getElementById('historyBtn').disabled = false;
            console.log('=== loadChatHistory 완료 ===');
        }
    }

    function showHistoryMessage(message) {
        var messages = document.getElementById('messages');
        var messageElement = document.createElement('div');
        messageElement.className = 'message';

        var currentEmail = document.getElementById('senderEmail').value;
        var isMyMessage = message.senderEmail === currentEmail;

        if (isMyMessage) {
            messageElement.className += ' my-message';
            messageElement.innerHTML = `<strong>나:</strong> ${message.content} <small style="color: #999;">(기록)</small>`;
        } else {
            messageElement.className += ' other-message';
            messageElement.innerHTML = `<strong>${message.senderName}:</strong> ${message.content} <small style="color: #999;">(기록)</small>`;
        }

        // 히스토리 메시지도 아래에 추가 (최신이 아래로)
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }

    function sendMessage() {
        var senderName = document.getElementById('senderName').value;
        var senderEmail = document.getElementById('senderEmail').value;
        var message = document.getElementById('messageInput').value;

        console.log('=== sendMessage 시작 ===');
        console.log('발신자:', senderName, senderEmail);
        console.log('메시지:', message);
        console.log('채팅방 ID:', currentChatRoomId);

        if (!currentChatRoomId) {
            alert('먼저 채팅방에 참여해주세요!');
            return;
        }

        if (!message.trim()) {
            alert('메시지를 입력해주세요!');
            return;
        }

        if (!isConnected || !stompClient) {
            alert('WebSocket 연결이 끊어졌습니다. 페이지를 새로고침 해주세요.');
            return;
        }

        const messageData = {
            'senderName': senderName,
            'senderEmail': senderEmail,
            'content': message,
            'chatRoomId': parseInt(currentChatRoomId),
            'senderId': getCurrentUserId() // JWT에서 사용자 ID 추출
        };

        console.log('전송할 메시지 데이터:', messageData);

        // 내 메시지를 즉시 화면에 표시
        showMessage(messageData, true); // true = 내 메시지임을 표시
        console.log('내 메시지 즉시 표시 완료');

        console.log('WebSocket으로 메시지 전송 중...');
        stompClient.send("/app/sendMessage", {}, JSON.stringify(messageData));
        console.log('WebSocket 전송 완료');

        // 메시지 입력창 클리어
        document.getElementById('messageInput').value = '';
    }

    function getCurrentUserId() {
        // JWT 토큰에서 사용자 ID 추출 (실제로는 JWT 파싱 라이브러리 사용 권장)
        var jwtToken = document.getElementById('jwtToken').value;
        try {
            var payload = JSON.parse(atob(jwtToken.split('.')[1]));
            return payload.id;
        } catch (e) {
            console.error('JWT 파싱 오류:', e);
            return 4; // 기본값
        }
    }

    function showMessage(message, isMyMessageSent = false) {
        var messages = document.getElementById('messages');
        var messageElement = document.createElement('div');
        messageElement.className = 'message';

        var currentEmail = document.getElementById('senderEmail').value;
        var isMyMessage = isMyMessageSent || (message.senderEmail === currentEmail);

        // 중복 메시지 방지 로직 개선
        if (!isMyMessageSent && message.senderEmail === currentEmail) {
            // 내가 보낸 메시지가 서버에서 다시 오는 경우, 최근 5개 메시지 중에서 중복 체크
            var existingMessages = Array.from(messages.children).slice(-5);
            var isDuplicate = existingMessages.some(msg => {
                return msg.textContent &&
                    msg.textContent.includes(message.content) &&
                    msg.classList.contains('my-message') &&
                    !msg.textContent.includes('(기록)'); // 기록 메시지는 제외
            });

            if (isDuplicate) {
                console.log('중복 메시지 방지:', message.content);
                return; // 중복 메시지는 표시하지 않음
            }
        }

        if (isMyMessage) {
            messageElement.className += ' my-message';
            messageElement.innerHTML = `<strong>나:</strong> ${message.content}`;
        } else {
            messageElement.className += ' other-message';
            messageElement.innerHTML = `<strong>${message.senderName}:</strong> ${message.content}`;
        }

        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;

        console.log('메시지 표시 완료:', {
            content: message.content,
            sender: message.senderName || message.senderEmail,
            isMyMessage: isMyMessage,
            isMyMessageSent: isMyMessageSent
        });
    }

    function showErrorMessage(error) {
        addErrorMessage("시스템 오류: " + error.content);
    }

    function addSystemMessage(message) {
        var messages = document.getElementById('messages');
        var messageElement = document.createElement('div');
        messageElement.className = 'message system-message';
        messageElement.textContent = message;
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }

    function addErrorMessage(message) {
        var messages = document.getElementById('messages');
        var messageElement = document.createElement('div');
        messageElement.className = 'message error-message';
        messageElement.textContent = message;
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }

    function updateCurrentChatRoom(roomId) {
        currentChatRoomId = roomId;
        document.getElementById('currentChatRoom').textContent = roomId ? `방 ID: ${roomId}` : '없음';
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function switchToUser1() {
        document.getElementById('senderName').value = '사용자1';
        document.getElementById('senderEmail').value = 'user1@user.com';
        document.getElementById('jwtToken').value = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMUB1c2VyLmNvbSIsImlkIjozLCJyb2xlIjoiVVNFUiIsImlhdCI6MTc1Mzc2OTk5NiwiZXhwIjoxNzUzNzcxNzk2fQ.example_token_for_user1';
        addSystemMessage('🔄 사용자1 (게시글 작성자)로 전환되었습니다.');

        // WebSocket 재연결
        if (stompClient && isConnected) {
            addSystemMessage('🔌 WebSocket 재연결 중...');
            stompClient.disconnect(() => {
                setTimeout(() => {
                    connect();
                }, 1000);
            });
        }
    }

    function switchToUser2() {
        document.getElementById('senderName').value = '사용자2';
        document.getElementById('senderEmail').value = 'user2@user.com';
        document.getElementById('jwtToken').value = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMkB1c2VyLmNvbSIsImlkIjo0LCJyb2xlIjoiVVNFUiIsImlhdCI6MTc1Mzc2OTk5NiwiZXhwIjoxNzUzNzcxNzk2fQ.UEmZ7n-r1VstflEaGpdi2fDxKjywJzrN83fkCwh9fkI';
        addSystemMessage('🔄 사용자2 (채팅 신청자)로 전환되었습니다.');

        // WebSocket 재연결
        if (stompClient && isConnected) {
            addSystemMessage('🔌 WebSocket 재연결 중...');
            stompClient.disconnect(() => {
                setTimeout(() => {
                    connect();
                }, 1000);
            });
        }
    }

    // 페이지 로드 시 자동 연결
    window.onload = function() {
        updateConnectionStatus('연결 중...');
        connect();
    };

    // 페이지 종료 시 연결 해제
    window.onbeforeunload = function() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    };
</script>
</body>
</html>
